<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>WDS JSON POST</title>
		<script type='text/javascript' src='http://fenixapps.fao.org/repository/js/jquery/1.8.1/jquery.min.js'></script>
		<script type='text/javascript' src='http://fenixapps.fao.org/repository/js/highcharts/2.3.5/js/highcharts.js'></script>
		<script type='text/javascript'>
			function query() {
				
				var sql = {};
				sql.selects = [];
				sql.froms = [];
				sql.wheres = [];
				sql.nestedWheres = [];
				sql.groupBys = [];
				sql.orderBys = [];
				sql.limit = '5';
				sql.query = null;
				sql.frequency = null;
				
				sql.selects.push({aggregation : "NONE", column : "D.Year", alias : "Year"});
				sql.selects.push({aggregation : "NONE", column : "I.ItemNameE", alias : "Area"});
				sql.selects.push({aggregation : "NONE", column : "D.Value", alias : "Value"});
				sql.selects.push({aggregation : "NONE", column : "E.UnitNameE", alias : "Unit"});
				
				sql.froms.push({"column" : "Item", "alias" : "I"});
				sql.froms.push({"column" : "Data", "alias" : "D"});
				sql.froms.push({column : "Element", alias : "E"});
				
				sql.wheres.push({datatype : "DATE", column : "D.ElementListCode", operator : "IN", value : null, ins : [2510]});
				sql.wheres.push({datatype : "TEXT", column : "D.DomainCode", operator : "=", value : "QC", ins : []})
				sql.wheres.push({datatype : "DATE", column : "I.ItemLevel", operator : "IN", value : null, ins : [5]});
				sql.wheres.push({datatype : "DATE", column : "D.ItemCode", operator : "=", value : "I.ItemCode", ins : []});
				sql.wheres.push({datatype : "DATE", column : "D.AreaCode",operator : "IN",value : null,ins : [4]});
				sql.wheres.push({datatype : "DATE", column : "D.ElementCode", operator : "=", value : "E.ElementCode", ins : []});
				sql.wheres.push({datatype : "DATE", column : "D.Year", operator : "IN", value : null, ins : [2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011]});
				
				sql.orderBys.push({"column" : "D.Value", "direction" : "DESC"});
				
				var nw = {
					"column" : "D.ItemCode",
					"nestedCondition" : {
						"selects" : [
							{"aggregation" : null, "column" : "D2.ItemCode", "alias" : "Code"}
						],
						"froms" : [
							{"column" : "Data", "alias" : "D2"},
							{"column" : "Item", "alias" : "I2"}
						],
						"wheres" : [
							{"datatype" : "TEXT", "column" : "D2.DomainCode", "operator" : "=", "value": "QC", "ins" : []},
							{"datatype" : "DATE", "column" : "D2.ItemCode", "operator" : "=", "value": "I2.ItemCode", "ins" : []},
							{"datatype" : "DATE", "column" : "D2.ElementListCode", "operator" : "IN", "value" : null, "ins" : [2510]},
							{"datatype" : "DATE", "column" : "I2.ItemLevel", "operator" : "IN", "value": null, "ins" : [5]},
							{"datatype" : "DATE", "column" : "D2.AreaCode", "operator" : "IN", "value": null, "ins" : [2]},
							{"datatype" : "DATE", "column" : "D2.Year", "operator" : "IN", "value" : null, "ins" : [2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011]}
						],
						groupBys : [
							{column : "D2.ItemCode"}
						],
						orderBys : [
							{column : "AVG(D2.Value)", direction : "DESC"}
						],
						"query": null,
						"frequency": null,
						"limit": 3
					}
				};
				
				sql.nestedWheres.push(nw);
				
				var data = {};
				data.datasource = 'faostat';
				data.thousandSeparator = ',';
				data.decimalSeparator = '.';
				data.decimalNumbers = '2';
				data.json = JSON.stringify(sql);
				data.cssFilename = 'faostat';

                console.log(JSON.stringify(sql));
				
				$.ajax({
					
					type : 'POST',
//					url : 'http://localhost:8080/wds/rest/table/json',
                    url : 'http://localhost:8080/wds/rest/table/excel',
					data : data,
						
					success : function(response) {
							
						console.log(response);

                        var newWin = open('url','windowName','height=300,width=300');
                        newWin.document.write(response);
							
					},
						
					error : function(err, b, c) {
							
					}
						
				});
				
			}
		</script>
		<script type='text/javascript'>
			function query2() {
				
				var sql = {};
				sql.selects = [];
				sql.froms = [];
				sql.wheres = [];
				sql.nestedWheres = [];
				sql.groupBys = [];
				sql.orderBys = [];
				sql.limit = 3;
				sql.query = null;
				sql.frequency = null;
				sql.skipCharactersReplacement = true;
				
				sql.selects.push({"aggregation" : null, "column" : "I.ItemNameE", "alias" : "Item"});
				sql.selects.push({"aggregation" : null, "column" : "E1.ElementNameE", "alias" : "E1"});
				sql.selects.push({"aggregation" : null, "column" : "D1.Value / 100", "alias" : "Value1"});
				sql.selects.push({"aggregation" : null, "column" : "E1.UnitNameE", "alias" : "MU1"});
				sql.selects.push({"aggregation" : null, "column" : "E2.ElementNameE", "alias" : "E2"});
				sql.selects.push({"aggregation" : null, "column" : "D2.Value / 1000000000", "alias" : "Value2"});
				sql.selects.push({"aggregation" : null, "column" : "E2.UnitNameE", "alias" : "MU1"});
				
				sql.froms.push({"column" : "Data", "alias" : "D1"});
				sql.froms.push({"column" : "Data", "alias" : "D2"});
				sql.froms.push({"column" : "Item", "alias" : "I"});
				sql.froms.push({"column" : "Element", "alias" : "E1"});
				sql.froms.push({"column" : "Element", "alias" : "E2"});
				
				sql.wheres.push({"datatype" : "TEXT", "column" : "D1.DomainCode", "operator" : "=", "value": "QC", "ins" : []});
				sql.wheres.push({"datatype" : "TEXT", "column" : "D2.DomainCode", "operator" : "=", "value": "QV", "ins" : []});
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.ItemCode", "operator" : "=", "value": "D2.ItemCode", "ins" : []})
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.ItemCode", "operator" : "=", "value": "I.ItemCode", "ins" : []})
				sql.wheres.push({"datatype" : "DATE", "column" : "D2.ItemCode", "operator" : "=", "value": "I.ItemCode", "ins" : []})
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.ElementCode", "operator" : "=", "value": "E1.ElementCode", "ins" : []})
				sql.wheres.push({"datatype" : "DATE", "column" : "D2.ElementListCode", "operator" : "=", "value": "E2.ElementListCode", "ins" : []})
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.ElementCode", "operator" : "IN", "value": null, "ins" : [5510]});
				sql.wheres.push({"datatype" : "DATE", "column" : "D2.ElementListCode", "operator" : "IN", "value": null, "ins" : [154]});
				sql.wheres.push({"datatype" : "DATE", "column" : "I.ItemLevel", "operator" : "IN", "value": null, "ins" : [5]});
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.AreaCode", "operator" : "IN", "value": null, "ins" : [5000]});
				sql.wheres.push({"datatype" : "DATE", "column" : "D2.AreaCode", "operator" : "IN", "value": null, "ins" : [5000]});
				sql.wheres.push({"datatype" : "DATE", "column" : "D1.Year", "operator" : "IN", "value": null, "ins" : [2010]});
				sql.wheres.push({"datatype" : "DATE", "column" : "D2.Year", "operator" : "IN", "value": null, "ins" : [2010]});
				
				sql.orderBys.push({"column" : "D1.Value", "direction" : "DESC"});
				
				var data = {};
				data.datasource = 'faostat';
				data.thousandSeparator = ',';
				data.decimalSeparator = '.';
				data.decimalNumbers = '2';
				data.json = JSON.stringify(sql);
				data.cssFilename = 'faostat';
				data.valueIndex = '1';
				
				$.ajax({
					
					type : 'POST',
					url : 'http://localhost:8080/wds/rest/table/json',
					data : data,
						
					success : function(response) {
						
						var categories = [];
						var series = [];
						var seriesNumber = (response[0].length - 1) / 3;
						var mus = [];
						var yAxis = [];
						
						for (var i = 0 ; i < response.length ; i++) {
							console.log(response[i]);
							categories.push(response[i][0]);
						}
						
						for (var i = 0 ; i < response[0].length - 1; i += 3) {
							var s = {};
							s.name = response[0][1 + i];
							s.type = 'line';
							s.data = [];
							mus.push(response[0][3 + i]);
							for (var j = 0 ; j < response.length ; j++) 
								s.data.push(parseFloat(response[j][2 + i]))
							series.push(s);
						}
						
						for (var i = 0 ; i < mus.length ; i++) {
							var a = {};
							a.title = {};
							a.title.text = mus[i];
							if (i > 0)
								a.opposite = true;
							yAxis.push(a);
						}
						
						console.log(yAxis);
							
						chart = new Highcharts.Chart({
							chart : {
								renderTo: 'chart',
								type: 'column',
								zoomType : 'xy'
							},
							xAxis: {
								categories: categories
							},
							title : {
								text : 'top something'
							},
							credits: {
				    			position : {
				    				align : 'left',
				    				x : 10
				    			},
				    			text : 'credits',
				    			href : null
				    		},
				    		tooltip: {
				    			formatter: function() {
				                   var s = '<b>' + this.x +'</b><br/>' + this.series.name + ': ' + this.y;
				                   return s;
				                }
				            },
				    		yAxis: yAxis,
							series: series
						});
							
					},
						
					error : function(err, b, c) {
							
					}
						
				});
				
			}
		</script>
		<script type='text/javascript'>
			function query3() {
				
				var sql = {};
				sql.limit = 3;
				sql.query = "SELECT I.ItemCode, I.ItemNameE FROM Item I WHERE I.ItemLevel = 5 ";
				sql.frequency = null;
				
				var data = {};
				data.datasource = 'faostat';
				data.thousandSeparator = ',';
				data.decimalSeparator = '.';
				data.decimalNumbers = '2';
				data.json = JSON.stringify(sql);
				data.cssFilename = 'faostat';
				data.valueIndex = '1';
				
				$.ajax({
					
					type : 'POST',
					url : 'http://localhost:8080/wds/rest/table/json',
					data : data,
						
					success : function(response) {
						console.log(response);
					},
					
					error : function(err, b, c) {

					}
					
				});
					
			}
		</script>
	</head>

	<body>
		<input type='button' value='TEST' onclick='query();' />
		<input type='button' value='CHART' onclick='query2();' />
		<input type='button' value='SQL' onclick='query3();' />
		<div id='chart' style='width: 100%; height: 350px;'></div>

        <form action="http://localhost:8080/wds/rest/table/excel" method="POST" target="_blank">
            <input type="hidden" id="datasource" name="datasource" value="faostat">
            <input type="hidden" id="thousandSeparator" name="thousandSeparator" value=",">
            <input type="hidden" id="decimalSeparator" name="decimalSeparator" value=".">
            <input type="hidden" id="decimalNumbers" name="decimalNumbers" value="2">
            <input type="hidden" id="json" name="json" value='{"selects":[{"aggregation":"NONE","column":"D.Year","alias":"Year"},{"aggregation":"NONE","column":"I.ItemNameE","alias":"Area"},{"aggregation":"NONE","column":"D.Value","alias":"Value"},{"aggregation":"NONE","column":"E.UnitNameE","alias":"Unit"}],"froms":[{"column":"Item","alias":"I"},{"column":"Data","alias":"D"},{"column":"Element","alias":"E"}],"wheres":[{"datatype":"DATE","column":"D.ElementListCode","operator":"IN","value":null,"ins":[2510]},{"datatype":"TEXT","column":"D.DomainCode","operator":"=","value":"QC","ins":[]},{"datatype":"DATE","column":"I.ItemLevel","operator":"IN","value":null,"ins":[5]},{"datatype":"DATE","column":"D.ItemCode","operator":"=","value":"I.ItemCode","ins":[]},{"datatype":"DATE","column":"D.AreaCode","operator":"IN","value":null,"ins":[4]},{"datatype":"DATE","column":"D.ElementCode","operator":"=","value":"E.ElementCode","ins":[]},{"datatype":"DATE","column":"D.Year","operator":"IN","value":null,"ins":[2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011]}],"nestedWheres":[{"column":"D.ItemCode","nestedCondition":{"selects":[{"aggregation":null,"column":"D2.ItemCode","alias":"Code"}],"froms":[{"column":"Data","alias":"D2"},{"column":"Item","alias":"I2"}],"wheres":[{"datatype":"TEXT","column":"D2.DomainCode","operator":"=","value":"QC","ins":[]},{"datatype":"DATE","column":"D2.ItemCode","operator":"=","value":"I2.ItemCode","ins":[]},{"datatype":"DATE","column":"D2.ElementListCode","operator":"IN","value":null,"ins":[2510]},{"datatype":"DATE","column":"I2.ItemLevel","operator":"IN","value":null,"ins":[5]},{"datatype":"DATE","column":"D2.AreaCode","operator":"IN","value":null,"ins":[2]},{"datatype":"DATE","column":"D2.Year","operator":"IN","value":null,"ins":[2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011]}],"groupBys":[{"column":"D2.ItemCode"}],"orderBys":[{"column":"AVG(D2.Value)","direction":"DESC"}],"query":null,"frequency":null,"limit":3}}],"groupBys":[],"orderBys":[{"column":"D.Value","direction":"DESC"}],"limit":"5","query":null,"frequency":null}'>
            <input type="hidden" id="cssFilename" name="cssFilename" value="faostat">
            <input type="submit">
        </form>

	</body>

</html>